{% extends 'base.html' %}

{% block title %} Fight {% endblock %}

{% block body %}
    <!--suppress JSAnnotator -->
    <div class="row">
        <div class="col-12 text-center">
            <h1>Fight</h1>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <textarea name="history"
                      class="form-control"
                      style="resize: none; height: 200px"
                      title="history"
                      readonly></textarea>
        </div>
    </div>

    <div id="game" style="display: none;">
        <div id="p1">
            <div class="row mt-3">
                <div class="col-12 text-center">Life: <span class="life"></span></div>
            </div>
            <div class="row cards"><!-- Auto generated --></div>
        </div>

        <hr>

        <div id="p2">
            <div class="row cards"><!-- Auto generated --></div>
            <div class="row mb-3">
                <div class="col-12 text-center">Life: <span class="life"></span></div>
            </div>
        </div>
    </div>


    <script>
        addHistory('Waiting another player...');

        const data = {{ fight_json }};
        let joinLocked = false;

        const socket = new WebSocket('ws://' + window.location.host + '/ws/fight/' + data.room_id + '/');
        let firstPlayer = {
            id: {{ request.user.id }},
            name: '{{ request.user.username }}',
            deck: data.deck_id
        };
        let secondPlayer = null;

        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);

            if (data.action === 'join') {
                joinAction(data);
            }

            if (data.action === 'start') {
                startAction(data);
            }
        };

        socket.onclose = function (e) {
            console.error('Chat socket closed unexpectedly');
        };

        function addHistory(text) {
            document.querySelector('textarea[name=history').value += text + '\n';
        }

        function joinAction(data) {
            if (!joinLocked && data.player.id !== firstPlayer.id) {
                if (data.player.deck) {
                    secondPlayer = data.player;
                    addHistory(`${secondPlayer.name} joined the room`);
                    joinLocked = true;

                    socket.send(JSON.stringify({
                        action: 'ready',
                        data: {
                            first: firstPlayer,
                            second: secondPlayer
                        }
                    }));
                }

                socket.send(JSON.stringify({
                    action: 'join',
                    data: {
                        player: firstPlayer
                    }
                }));
            }
        }

        function startAction(data) {
            addHistory('Ready to start');
            document.getElementById('game').style.display = 'block';

            console.log(firstPlayer, data.first);
            console.log(secondPlayer, data.second);

            let updatedData = [];
            updatedData[0] = data.first;
            updatedData[1] = data.second;

            if (updatedData[0].user !== firstPlayer.id) {
                let tmp = updatedData[0];
                updatedData[0] = updatedData[1];
                updatedData[1] = tmp;
            }

            updatePlayerOne(updatedData[1]);
            updatePlayerTwo(updatedData[0]);
        }

        function updatePlayerOne(data) {
            document.querySelector('#game #p1 .life').innerText = data.life;

            const cardsDiv = document.querySelector('#game #p1 .cards');
            cardsDiv.innerHTML = '';
            for (let i = 0; i < data.cards.length; i++) {
                const col = document.createElement('div');
                col.classList.add('col-3');

                const img = document.createElement('img');
                img.setAttribute('src', 'https://dummyimage.com/307x465');
                img.classList.add('img-fluid');
                img.style.padding = '6px';

                col.appendChild(img);
                cardsDiv.appendChild(col);
            }
        }

        function updatePlayerTwo(data) {
            document.querySelector('#game #p2 .life').innerText = data.life;

            const cardsDiv = document.querySelector('#game #p2 .cards');
            cardsDiv.innerHTML = '';
            for (let i = 0; i < data.cards.length; i++) {
                const col = document.createElement('div');
                col.classList.add('col-3');

                const img = document.createElement('img');
                img.setAttribute('src', data.cards[i].img);
                img.setAttribute('alt', 'Attack: ' + data.cards[i].attack)
                img.classList.add('img-fluid');
                img.style.padding = '6px';

                col.appendChild(img);
                cardsDiv.appendChild(col);
            }
        }
    </script>
{% endblock %}
